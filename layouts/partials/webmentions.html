{{ $thisURL := ""}}
{{ if $.Site.Params.webmentionTestUrl }}
<!-- If During Development -->
    {{ $thisURL = printf "https://markgroves.us%s" $.RelPermalink }}
{{ else }}
    {{ $thisURL = $.Permalink }}    
{{ end }}


{{ $thisReplies := dict }}
{{ range $k, $v := .Site.Data.webmentions }}    
    {{ with . }}
        {{ if eq .target $thisURL}}
            {{ $dValue := dict $k $v }}
             {{ $thisReplies = merge $thisReplies $dValue }}      
        {{ else }}
            
        {{end }}
    {{ end }}
{{ end }}



{{ $thisLikes := dict }}
{{ $thisInReplyTo := dict }}
{{ $thisMentionOf := dict }}
{{ range $k, $v := $thisReplies }}
    {{ with . }}   
        
        
        {{ if isset .post "wm-property" }}
            
            {{ if eq (index .post "wm-property") "like-of"}}
                {{ $dValue := dict $k $v }}
                {{ $thisLikes = merge $thisLikes $dValue }}
            {{ else if eq (index .post "wm-property") "in-reply-to"}}
                {{ $dValue := dict $k $v }}
                {{ $thisInReplyTo = merge $thisInReplyTo $dValue }}
            {{ else if eq (index .post "wm-property") "mention-of"}}
                {{ $dValue := dict $k $v }}
                {{ $thisMentionOf = merge $thisMentionOf $dValue }}
            {{ end }}
        {{ end }}
    {{ end }}
{{ end }}  

{{ with $thisLikes }}
    <div class="webmentions">
        <div class="pagination">
                <div class="pagination__title">
                        <span class="pagination__title-h">Likes</span>
                        <hr/>
                    </div>
        </div>
    <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(10em,1fr));">
                    
    {{ range $thisLikes }}
        {{ with .post }}
            <div class="u-comment h-cite">
                <div style="display: inline-flex; padding: 1rem;">
                    <a class="u-author h-card" style="flex-grow: 1;" {{- if .url -}} href="{{ .url }}" {{ end }}>            
                        <span style="display:block; flex-grow: 1;">{{ .author.name | humanize }}</span>
                    </a>
                    <a class="h-card" {{ if .author.url }} href="{{ .author.url }}" {{ end }}><img src="{{ .author.photo }}" style="width: 1.7rem; height: 1.7rem; border-radius: 50%;"/></a>
                </div>
            </div>
        {{ end }}
    {{ end }}
    </div>
    </div>
{{ end }}
{{ with $thisInReplyTo }}
    <div class="pagination__title">
        <span class="pagination__title-h">Replies</span>
        <hr/>
    </div>
    
    {{ range $thisInReplyTo }}
        {{ with .post }}
            <div class="u-comment h-cite">
                <a class="u-author h-card" {{- if .author.url -}} href="{{ .author.url }}" {{ end }}>            
                    {{ .author.name | humanize }}
                </a>
            </p>
                <p class="e-content e-name">
                    {{- .content.html | safeHTML }}
                </p>
                <a class="u-url" href="{{ .url }}">
                    {{ .url }}
                </a>
                &nbsp;@
                <time class="dt-published">{{ if .published }}{{ dateFormat $.Site.Params.dateformNumTime .published }}{{ end }}</time>  
            </div>
        <hr/>
        {{ end }}
    {{ end }}
{{ end }}

{{ with $thisMentionOf }}
    <div class="pagination__title">
        <span class="pagination__title-h">Mentions</span>
        <hr/>
    </div>
    {{ range $thisMentionOf }}
        {{ with .post }}
            <div class="u-comment h-cite">
                <a class="u-author h-card" {{- if .author.url -}} href="{{ .author.url }}" {{ end }}>            
                    {{ .author.name | humanize }}
                </a>
            </p>
                <p class="e-content e-name">
                    {{- .content.html | safeHTML }}
                </p>
                <a class="u-url" href="{{ .url }}">
                    {{ .url }}
                </a>
                &nbsp;@
                <time class="dt-published">{{ if .published }}{{ dateFormat $.Site.Params.dateformNumTime .published }}{{ end }}</time>  
            </div>
        {{ end }}
    {{ end }}
{{ end }}